<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>ip_range :: GiddyPoet&#39;s Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="ip地址范围判断问题 在实现场景中，时长遇到需要判断ip地址是否在范围内，或者ip地址是否在这个网段内，因此将简述ip地址判断问题，目前支持以" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://giddypoet.github.io/posts/ip-range/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://giddypoet.github.io/styles.css">







  <link rel="shortcut icon" href="https://giddypoet.github.io/img/theme-colors/blue.png">
  <link rel="apple-touch-icon" href="https://giddypoet.github.io/img/theme-colors/blue.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="ip_range">
<meta property="og:description" content="ip地址范围判断问题 在实现场景中，时长遇到需要判断ip地址是否在范围内，或者ip地址是否在这个网段内，因此将简述ip地址判断问题，目前支持以" />
<meta property="og:url" content="https://giddypoet.github.io/posts/ip-range/" />
<meta property="og:site_name" content="GiddyPoet&#39;s Blog" />

  
    <meta property="og:image" content="https://giddypoet.github.io/img/favicon/blue.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="os" />


  <meta property="article:published_time" content="2022-06-13 15:07:07 &#43;0000 UTC" />












</head>
<body class="blue">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    GiddyPoet&#39;s Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="../about">About</a></li>
        
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="../about">About</a></li>
        
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://giddypoet.github.io/posts/ip-range/">ip_range</a>
  </h1>
  <div class="post-meta">
    
      <time class="post-date">
        2022-06-13 ::
        
      </time>
    
    
    
      <span class="post-reading-time">:: 5 min read (2181 words)</span>
    
  </div>

  
    <span class="post-tags">
      
      #<a href="https://giddypoet.github.io/tags/network/">network</a>&nbsp;
      
    </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Table of Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#ip地址判断">ip地址判断</a>
      <ul>
        <li><a href="#ip地址格式">ip地址格式</a></li>
        <li><a href="#地址格式转换">地址格式转换</a></li>
        <li><a href="#ip地址范围判定">ip地址范围判定</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <h1 id="ip地址范围判断问题">ip地址范围判断问题<a href="#ip地址范围判断问题" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>在实现场景中，时长遇到需要判断ip地址是否在范围内，或者ip地址是否在这个网段内，因此将简述ip地址判断问题，目前支持以下场景。</p>
<ul>
<li>ip1-ip2</li>
<li>ip/CIDR (ip/24)</li>
<li>ip/netmask (ip/255.255.255.0)</li>
</ul>
<h2 id="ip地址判断">ip地址判断<a href="#ip地址判断" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="ip地址格式">ip地址格式<a href="#ip地址格式" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>常用的地址格式类型：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sockaddr {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span>    sa_family;    <span style="color:#75715e">// address family, AF_xxx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">char</span>              sa_data[<span style="color:#ae81ff">14</span>];  <span style="color:#75715e">// 14 bytes of protocol address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sockaddr_in {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">short</span>            sin_family;   <span style="color:#75715e">// e.g. AF_INET, AF_INET6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span>   sin_port;     <span style="color:#75715e">// e.g. htons(3490)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> in_addr   sin_addr;     <span style="color:#75715e">// see struct in_addr, below
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span>             sin_zero[<span style="color:#ae81ff">8</span>];  <span style="color:#75715e">// zero this if you want to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sockaddr_in6 {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">u_int16_t</span>       sin6_family;   <span style="color:#75715e">// address family, AF_INET6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">u_int16_t</span>       sin6_port;     <span style="color:#75715e">// port number, Network Byte Order
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">u_int32_t</span>       sin6_flowinfo; <span style="color:#75715e">// IPv6 flow information
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> in6_addr sin6_addr;     <span style="color:#75715e">// IPv6 address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">u_int32_t</span>       sin6_scope_id; <span style="color:#75715e">// Scope ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sockaddr_storage {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">sa_family_t</span>  ss_family;     <span style="color:#75715e">// address family
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// all this is padding, implementation specific, ignore it:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span>      __ss_pad1[_SS_PAD1SIZE];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int64_t</span>   __ss_align;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span>      __ss_pad2[_SS_PAD2SIZE];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li><code>struct sockaddr</code> 通常不会自己创建，该结构体，一般都是通过<code>struct sockaddr_in</code>和<code>struct sockaddr_in6</code>进行转换，由于历史因素，因此套接字api都只支持<code>struct sockaddr</code>，通过family字段进行判断，同时支持ipv4和ipv6，如果一个ip地址是ipv4,它只会读取其前4个字节，如果是ipv6，则会读取完整的16个字节.s</li>
<li><code>struct sockaddr_in</code> ipv4地址格式</li>
<li><code>struct sockaddr_in6</code> ipv6地址格式</li>
<li><code>struct sockaddr_storage</code> 当你不知道地址类型具体是什么的时候可以使用该结构体，该结构体即支持ipv4也支持ipv6，该地址类型被设计的足够大可以支持<code>struct sockaddr_un</code></li>
</ul>
<blockquote>
<p>对于unix socket需要通过offsetof实现绑定，addrlen = offsetof(struct sockaddr_un, sun_path) + strlen(un.sun_path); 需要制定具体的长度，上述地址格式一般都是历史遗留问题。</p>
</blockquote>
<h3 id="地址格式转换">地址格式转换<a href="#地址格式转换" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<blockquote>
<p>从文件中读取ip地址，进行判断，通常这种配置都是通过点分形式通知，因此需要将ipstr转换成地址</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _IPSTORAGE {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> is_ipv6;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">in_addr_t</span> ipv4;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> in6_addr ipv6;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}IPSTORAGE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define ISIPV6(str) (strchr(str,&#39;:&#39;)?true:false)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">is_legal_ip_addr</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>str) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[INET6_ADDRSTRLEN];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">ISIPV6</span>(str)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">inet_pton</span>(AF_INET6, str, buf) <span style="color:#f92672">?</span> true <span style="color:#f92672">:</span> false;
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">inet_pton</span>(AF_INET, str, buf) <span style="color:#f92672">?</span> true <span style="color:#f92672">:</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IPSTORAGE <span style="color:#a6e22e">str2ipstorage</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>str) {
</span></span><span style="display:flex;"><span>    IPSTORAGE is;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">ISIPV6</span>(str)) {
</span></span><span style="display:flex;"><span>        is.is_ipv6 <span style="color:#f92672">=</span> true; 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">inet_pton</span>(AF_INET6, str, <span style="color:#f92672">&amp;</span>is.ipv6);
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        is.is_ipv6 <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">inet_pton</span>(AF_INET, str, <span style="color:#f92672">&amp;</span>is.ipv4);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>f <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;./test.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(f <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">127</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">128</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#a6e22e">fgets</span>(buf, <span style="color:#66d9ef">sizeof</span>(buf), f)<span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>        buf[<span style="color:#a6e22e">strlen</span>(buf) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">is_legal_ip_addr</span>(buf)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;illegal ip addr %s.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">memset</span>(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>; 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ip addr %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,buf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        IPSTORAGE is <span style="color:#f92672">=</span> <span style="color:#a6e22e">str2ipstorage</span>(buf);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memset</span>(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上述代码就是常见的字符串转ip地址的常用场景，主要说明一下几点：</p>
<ol>
<li>为什么要自己定义IPSTORAGE，实际上就是便于处理ipv4和ipv6的兼容性，<code>struct sockaddr_storage</code>也能实现该功能，但是还是要借助<code>struct sockaddr_in</code>和<code>struct sockaddr_in6</code>，用union处理<code>in_addr_t</code>和<code>struct in6_addr</code>处理起来较为方便。</li>
<li>利用inet_pton检查ip格式的合法性，这个比较常见。</li>
</ol>
<h3 id="ip地址范围判定">ip地址范围判定<a href="#ip地址范围判定" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="ip1-ip2">ip1-ip2<a href="#ip1-ip2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">ipstorage_lt</span>(IPSTORAGE <span style="color:#f92672">*</span>is1, IPSTORAGE <span style="color:#f92672">*</span>is2) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(is1<span style="color:#f92672">-&gt;</span>is_ipv6) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">&amp;</span>is1<span style="color:#f92672">-&gt;</span>ipv6, <span style="color:#f92672">&amp;</span>is2<span style="color:#f92672">-&gt;</span>ipv6, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> in6_addr)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> true <span style="color:#f92672">:</span> false;
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (is<span style="color:#f92672">-&gt;</span>ipv4) <span style="color:#f92672">&lt;</span> (is<span style="color:#f92672">-&gt;</span>ipv4);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">ipstorage_gt</span>(IPSTORAGE <span style="color:#f92672">*</span>is1, IPSTORAGE <span style="color:#f92672">*</span>is2) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">ipstorage_lt</span>(is1,is2);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">ipstorage_between</span>(IPSTORAGE <span style="color:#f92672">*</span>dst, IPSTORAGE <span style="color:#f92672">*</span>left, IPSTORAGE <span style="color:#f92672">*</span>right) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(dst<span style="color:#f92672">-&gt;</span>is_ipv6 <span style="color:#f92672">!=</span> left<span style="color:#f92672">-&gt;</span>is_ipv6) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">ipstorage_gt</span>(dst, right) <span style="color:#f92672">||</span> <span style="color:#a6e22e">ipstorage_lt</span>(dst, left)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>其实ipv4地址基于网络字节序或者主机字节序做比较都可以，只是由现成将str转换成网络字节序的函数，直接用网络字节序比较方便
ipv6的地址比较直接比较内存大小就可以，ipv6是16个uint8做比较。</p>
</blockquote>
<h4 id="ipcidr或ipnetmask">ip/CIDR或ip/netmask<a href="#ipcidr或ipnetmask" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>先做判断，只要判断&quot;/&ldquo;后是不是地址，就可以区分CIDR或netmask。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">is_ipv4</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ip) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[INET_ADDRSTRLEN];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">inet_pton</span>(AF_INET, ip, buf)<span style="color:#f92672">?</span> true<span style="color:#f92672">:</span> false;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 255.255.255.0 = 1111 1111 1111 1111 1111 1111 0000 0000 位运算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mask2prefix</span>(<span style="color:#66d9ef">struct</span> in_addr addr) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> count;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> saddr <span style="color:#f92672">=</span> <span style="color:#a6e22e">ntohl</span>(mask.s_addr);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; saddr <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; count<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        saddr <span style="color:#f92672">=</span> saddr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> count;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> in_addr <span style="color:#a6e22e">prefix2mask</span>(<span style="color:#66d9ef">int</span> prefix) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> in_addr addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(prefix) {
</span></span><span style="display:flex;"><span>        addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">htonl</span>(<span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> (<span style="color:#ae81ff">32</span> <span style="color:#f92672">-</span> preix) <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">htonl</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> addr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">is_ipv6_host_in_route</span>(IPSTORAGE <span style="color:#f92672">*</span>is1, <span style="color:#66d9ef">int</span> prefix, IPSTORAGE <span style="color:#f92672">*</span>is2) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> in6_addr <span style="color:#f92672">*</span>route <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>is1<span style="color:#f92672">-&gt;</span>ipv6;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> in6_addr <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>is2<span style="color:#f92672">-&gt;</span>ipv6;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// prefix是8的整数的每个uint8_t 做对比，剩下的不足一个字节的 前bit个位做对比
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> bits <span style="color:#f92672">=</span> prefix;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; bits <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">8</span>; i<span style="color:#f92672">++</span>, bits <span style="color:#f92672">-=</span><span style="color:#ae81ff">8</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(route<span style="color:#f92672">-&gt;</span>s6_addr[i] <span style="color:#f92672">!=</span> host<span style="color:#f92672">-&gt;</span>s6_addr[i]) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(bits <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> mask <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">&lt;&lt;</span>( <span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> bits);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((route<span style="color:#f92672">-&gt;</span>s6_addr[i]<span style="color:#f92672">&amp;</span>mask) <span style="color:#f92672">==</span> (host<span style="color:#f92672">-&gt;</span>s6_addr[i] <span style="color:#f92672">&amp;</span> mask)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">ipstorage_inside</span>(IPSTORAGE <span style="color:#f92672">*</span>is1, <span style="color:#66d9ef">int</span> prefix, IPSTORAGE <span style="color:#f92672">*</span>is2) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(is1<span style="color:#f92672">-&gt;</span>is_ipv6 <span style="color:#f92672">!=</span> is2<span style="color:#f92672">-&gt;</span>is_ipv6) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(is1<span style="color:#f92672">-&gt;</span>is_ipv6) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">is_ipv6_host_in_route</span>(is1, prefix, is2);
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> in_addr in <span style="color:#f92672">=</span> <span style="color:#a6e22e">prefix2mask</span>(prefix);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> mask <span style="color:#f92672">=</span> <span style="color:#a6e22e">ntohl</span>(in_addr.s_addr);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>((is1<span style="color:#f92672">-&gt;</span>ipv4 <span style="color:#f92672">&amp;</span> mask) <span style="color:#f92672">==</span> (is2<span style="color:#f92672">-&gt;</span>ipv4 <span style="color:#f92672">&amp;</span> mask)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(ptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">strchr</span>(str, <span style="color:#e6db74">&#39;/&#39;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>ptr<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> prefix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((<span style="color:#a6e22e">is_ipv4</span>(ptr))) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// netmask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> in_addr maskaddr;
</span></span><span style="display:flex;"><span>        maskaddr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(ptr);
</span></span><span style="display:flex;"><span>        prefix <span style="color:#f92672">=</span> <span style="color:#a6e22e">mask2prefix</span>(maskaddr);
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// CIDR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        prefix <span style="color:#f92672">=</span> <span style="color:#a6e22e">atoi</span>(ptr);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    IPSTORAGE is1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">str2ipstorage</span>(buf);
</span></span><span style="display:flex;"><span>    IPSTORAGE is2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">str2ipstorage</span>(dst_ip);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">ipstrorage_inside</span>(<span style="color:#f92672">&amp;</span>is1, prefix, <span style="color:#f92672">&amp;</span>is2)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ip in range.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>实际上上述的操作都是利用了两个特性</p>
<ol>
<li>ipv4地址实际上是一个uint32_t</li>
<li>ipv6地址实际上是一个uint8_t[16], 这样就不区分主机字节序或网络字节序了</li>
</ol>
</blockquote>
<ol>
<li>先获取到子网掩码</li>
<li>如果是ipv4的话就直接通过主机号做判断，地址1 &amp; 子网掩码 == 地址2 &amp; 子网掩码</li>
<li>如果是ipv6的话就每一个字节进行判断，不足一个字节，取高bits，(is1-&gt;s6_addr[i] &amp; bits) == (is2-&gt;s6_addr[i] &amp; bits)</li>
</ol>
<h5 id="ipv6不区分网络字节序相关验证">ipv6不区分网络字节序相关验证<a href="#ipv6不区分网络字节序相关验证" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>str6 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fec1::02&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> prefix <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> in6_addr ipv6;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">inet_pton</span>(AF_INET6, str6, <span style="color:#f92672">&amp;</span>ipv6); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span> ;i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x &#34;</span>, ipv6.s6_addr[i]);
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}                                         
</span></span></code></pre></div><h4 id="对于unix-socket的相关操作">对于unix socket的相关操作<a href="#对于unix-socket的相关操作" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stddef.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/un.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PATH &#34;/tmp/GiddyPoet&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_un un;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_storage ss;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">socklen_t</span> len;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">unlink</span>(PATH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_UNIX, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>un ,<span style="color:#ae81ff">0</span> , <span style="color:#66d9ef">sizeof</span>(un));
</span></span><span style="display:flex;"><span>    un.sun_family <span style="color:#f92672">=</span> AF_UNIX;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(un.sun_path, PATH);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> addrlen <span style="color:#f92672">=</span> <span style="color:#a6e22e">offsetof</span>(<span style="color:#66d9ef">struct</span> sockaddr_un, sun_path) <span style="color:#f92672">+</span> <span style="color:#a6e22e">strlen</span>(PATH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bind</span>(fd, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>un, addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">listen</span>(fd, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(fd, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>ss, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(ss.ss_family <span style="color:#f92672">==</span> AF_UNIX) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;AF_UNIX.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define offsetof(st, m) ((size_t) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ((char *)&amp;((st *)0)-&gt;m - (char *)0))
</span></span></span></code></pre></div><p>简单介绍下<code>offsetof</code>，通过将起始地址为0的结构体中的m成员获取，m在结构体中的偏移量，然后转换成<code>char *</code>计算出具体偏移的字节数, ((st *)(0))指的NULL是类型的指针st *。 &amp;((st *)(0))-&gt;m指的是这个对象中成员m的地址。由于这个对象的起始地址是0 (NULL)，所以成员 m 的地址就是偏移量。</p>
<h4 id="contain_of">contain_of<a href="#contain_of" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>contain_of是通过结构体内成员的地址返回结构体本身的地址，在内核代码里有大量使用，典型的就是list.h。</p>
<p>既然介绍了offset，顺便介绍下contain_of, <code>const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr)</code>获取同类型的指针，<code>offsetof(type,member)</code>计算出结构体成员的相对偏移量，<code>( (char *)__mptr - offsetof(type,member) )</code>获取机构体本身的地址，<code>(type *)( (char *)__mptr - offsetof(type,member) )</code>转换成结构体类型返回。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define container_of(ptr, type, member) ({			\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);	\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	(type *)( (char *)__mptr - offsetof(type,member) );})
</span></span></span></code></pre></div>
      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://giddypoet.github.io/posts/raw-socket/">
                <span class="button__icon">←</span>
                <span class="button__text">raw_socket</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://giddypoet.github.io/posts/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/">
                <span class="button__text">操作系统导论</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2023 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
